@using Microsoft.JSInterop;
@using System.Text.Json;
@using Vizor.ECharts.Options;

@typeparam TData
@namespace Vizor.ECharts

@inject IJSRuntime jsRuntime
@implements IAsyncDisposable

<div id="@Id" class="@CssClass" style="@Style"></div>

@code {

	[Parameter]
	public string Id { get; set; } = "chart-" + Guid.NewGuid().ToString();

	[Parameter]
	public string? CssClass { get; set; }

	[Parameter]
	public string? Style { get; set; }

	[Parameter]
	public string? Width { get; set; }

	[Parameter]
	public string? Height { get; set; }

	[Parameter]
	public string? Theme { get; set; }

	[Parameter, EditorRequired]
	public ChartOptions<TData> Options { get; set; } = default!;

	[Parameter]
	public FunctionMap? FunctionMap { get; set; }

	protected override Task OnInitializedAsync()
	{
		return base.OnInitializedAsync();

		//TODO: async data loaders
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		// echarts.init the very first time the component is rendered

		if (!firstRender)
			return;

		if (Options == null)
			throw new ArgumentException("Options property must be set");
		if (string.IsNullOrWhiteSpace(Id))
			throw new ArgumentException("Id property must be set");

		var jsonOpts = new JsonSerializerOptions()
			{
				PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
				DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull,
#if DEBUG
					WriteIndented = true
#endif
			};

		var chartOpts = JsonSerializer.Serialize(Options, jsonOpts);

		// Remark: ECharts allows JS functions in the options, which is not allowed by the .NET JSON serializer, even when using Utf8JsonWriter.SkipValidation+JavaScriptEncoder.UnsafeRelaxedJsonEscaping
		// This forces us to do a 2 stage serialization process with an expensive string search+replace
		// Another option would be using Newtonsoft.Json, but this would add a dependency that I don't want to add ...

		if (FunctionMap != null)
			chartOpts = FunctionMap.MapFunctions(chartOpts);

		await jsRuntime.InvokeVoidAsync("vizorECharts.initChart", /*DotNetObjectReference.Create(this),*/ Id, chartOpts, Theme, Width, Height);
	}

	public async ValueTask DisposeAsync()
	{
		try
		{
			await jsRuntime.InvokeVoidAsync("vizorECharts.disposeChart", Id);
		}
		catch { }
	}
}
